<!--pages/theme/store/store.wxml-->
<scroll-view
  id="top"
  class="container"
  scroll-y
  scroll-into-view="{{scrollIntoView}}"
  bindscroll="onScroll"
  style="background: {{cssVars['--theme-background']}};"
>
  <!-- 头部 -->
  <view
    class="header"
    style="background: {{cssVars['--theme-surface']}}F0;"
  >
    <view class="header-title" style="color: {{cssVars['--theme-text-primary']}};">主题商店</view>
    <view class="header-info">
      <view class="info-item" style="color: {{cssVars['--theme-text-secondary']}};">
        <svg class="info-icon" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" stroke="{{cssVars['--theme-accent']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <text>积分: {{userPoints}}</text>
      </view>
      <view class="info-item" style="color: {{cssVars['--theme-text-secondary']}};">
        <svg class="info-icon" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="8" stroke="{{cssVars['--theme-secondary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M14.5 8.5c-.5-1-1.5-1.5-2.5-1.5-2 0-3 1.5-3 3s1 3 3 3 3 1.5 3 3-1 3-3 3c-1 0-2-.5-2.5-1.5M12 3v3m0 12v3" stroke="{{cssVars['--theme-secondary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <text>心晴币: {{userCoins}}</text>
      </view>
      <view class="info-item" style="color: {{cssVars['--theme-text-secondary']}};">
        <svg class="info-icon" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="16" y1="2" x2="16" y2="6" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="8" y1="2" x2="8" y2="6" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="3" y1="10" x2="21" y2="10" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <text>连签: {{continuousDays}}天</text>
      </view>
    </view>
  </view>

  <!-- 当前主题预览 -->
  <view class="current-theme-section">
    <view class="section-title" style="color: {{cssVars['--theme-text-primary']}};">当前主题</view>
    <view
      class="current-theme-card"
      style="background: {{currentTheme.colors.background}};"
    >
      <view class="theme-name" style="color: {{currentTheme.colors.textPrimary}};">
        {{currentTheme.name}}
      </view>
      <view class="color-preview">
        <view
          class="color-dot"
          style="background: {{currentTheme.colors.primary}};"
        />
        <view
          class="color-dot"
          style="background: {{currentTheme.colors.secondary}};"
        />
        <view
          class="color-dot"
          style="background: {{currentTheme.colors.accent}};"
        />
      </view>
      <view
        class="active-badge"
        style="background: {{currentTheme.colors.surface}}; color: {{currentTheme.colors.primary}};"
      >
        <text>✓</text>
        <text>使用中</text>
      </view>
    </view>
  </view>

  <!-- 免费主题 -->
  <view class="theme-group">
    <view class="group-header">
      <text class="group-title" style="color: {{cssVars['--theme-text-primary']}};">免费主题</text>
    </view>
    <view class="theme-grid">
      <view
        wx:for="{{freeThemes}}"
        wx:key="id"
        class="theme-card"
        data-theme-id="{{item.id}}"
        bindtap="onThemeCardTap"
        style="background: {{item.colors.background}}; opacity: {{item.isUnlocked || item.canUnlock ? 1 : 0.6}};"
      >
        <view class="color-preview">
          <view class="color-dot-small" style="background: {{item.colors.primary}};" />
          <view class="color-dot-small" style="background: {{item.colors.secondary}};" />
          <view class="color-dot-small" style="background: {{item.colors.accent}};" />
        </view>
        <view class="card-theme-name" style="color: {{item.colors.textPrimary}};">
          {{item.name}}
        </view>
        <view
          class="status-badge {{item.isActive ? 'active' : ''}} {{item.isUnlocked ? 'unlocked' : ''}}"
          style="background: {{item.isActive || item.isUnlocked ? item.colors.surface : (item.colors.surface || '#F5F5F5')}}; color: {{item.colors.primary}};"
        >
          <text wx:if="{{item.isActive}}">✓ 使用中</text>
          <text wx:elif="{{item.isUnlocked}}">✓ 已解锁</text>
          <block wx:else>
            <svg width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 4rpx;">
              <rect x="4" y="9" width="16" height="12" rx="1" stroke="{{item.colors.primary}}" stroke-width="2"/>
              <line x1="12" y1="9" x2="12" y2="21" stroke="{{item.colors.primary}}" stroke-width="1.5"/>
              <path d="M4 12h16" stroke="{{item.colors.primary}}" stroke-width="1.5"/>
              <path d="M7 9c0-2 1-4 5-4s5 2 5 4" stroke="{{item.colors.primary}}" stroke-width="1.5"/>
            </svg>
            <text>免费</text>
          </block>
        </view>
      </view>
    </view>
  </view>

  <!-- 签到解锁 -->
  <view class="theme-group">
    <view class="group-header">
      <text class="group-title" style="color: {{cssVars['--theme-text-primary']}};">签到解锁</text>
      <view class="group-badge" style="background: {{cssVars['--theme-primary']}}20; color: {{cssVars['--theme-primary']}};">
        <svg class="badge-icon" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="16" y1="2" x2="16" y2="6" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="8" y1="2" x2="8" y2="6" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <line x1="3" y1="10" x2="21" y2="10" stroke="{{cssVars['--theme-primary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <text>签到</text>
      </view>
    </view>
    <view class="theme-grid">
      <view
        wx:for="{{signinThemes}}"
        wx:key="id"
        class="theme-card"
        data-theme-id="{{item.id}}"
        bindtap="onThemeCardTap"
        style="background: {{item.colors.background}}; opacity: {{item.isUnlocked || item.canUnlock ? 1 : 0.6}};"
      >
        <view class="color-preview">
          <view class="color-dot-small" style="background: {{item.colors.primary}};" />
          <view class="color-dot-small" style="background: {{item.colors.secondary}};" />
          <view class="color-dot-small" style="background: {{item.colors.accent}};" />
        </view>
        <view class="card-theme-name" style="color: {{item.colors.textPrimary}};">
          {{item.name}}
        </view>
        <view
          class="status-badge {{item.isActive ? 'active' : ''}} {{item.isUnlocked ? 'unlocked' : ''}}"
          style="background: {{item.isActive || item.isUnlocked ? item.colors.surface : (item.canUnlock ? item.colors.surface : 'rgba(0,0,0,0.3)')}}; color: {{item.isActive || item.isUnlocked ? item.colors.primary : (item.canUnlock ? item.colors.primary : '#FFFFFF')}};"
        >
          <text wx:if="{{item.isActive}}">✓ 使用中</text>
          <text wx:elif="{{item.isUnlocked}}">✓ 已解锁</text>
          <view wx:else style="display: flex; align-items: center; gap: 4rpx;">
            <svg width="12" height="12" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="{{item.canUnlock ? item.colors.primary : '#FFFFFF'}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="16" y1="2" x2="16" y2="6" stroke="{{item.canUnlock ? item.colors.primary : '#FFFFFF'}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="8" y1="2" x2="8" y2="6" stroke="{{item.canUnlock ? item.colors.primary : '#FFFFFF'}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <line x1="3" y1="10" x2="21" y2="10" stroke="{{item.canUnlock ? item.colors.primary : '#FFFFFF'}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <text>{{item.signinDays}}天</text>
          </view>
        </view>
        <view wx:if="{{!item.isUnlocked && !item.canUnlock}}" class="lock-overlay">
          <svg class="lock-icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </view>
      </view>
    </view>
  </view>

  <!-- 积分兑换 -->
  <view class="theme-group">
    <view class="group-header">
      <text class="group-title" style="color: {{cssVars['--theme-text-primary']}};">积分兑换</text>
      <view class="group-badge" style="background: {{cssVars['--theme-accent']}}20; color: {{cssVars['--theme-accent']}};">
        <svg class="badge-icon" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" stroke="{{cssVars['--theme-accent']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <text>积分</text>
      </view>
    </view>
    <view class="theme-grid">
      <view
        wx:for="{{pointsThemes}}"
        wx:key="id"
        class="theme-card"
        data-theme-id="{{item.id}}"
        bindtap="onThemeCardTap"
        style="background: {{item.colors.background}}; opacity: {{item.isUnlocked || item.canUnlock ? 1 : 0.6}};"
      >
        <view class="color-preview">
          <view class="color-dot-small" style="background: {{item.colors.primary}};" />
          <view class="color-dot-small" style="background: {{item.colors.secondary}};" />
          <view class="color-dot-small" style="background: {{item.colors.accent}};" />
        </view>
        <view class="card-theme-name" style="color: {{item.colors.textPrimary}};">
          {{item.name}}
        </view>
        <view
          class="status-badge {{item.isActive ? 'active' : ''}} {{item.isUnlocked ? 'unlocked' : ''}}"
          style="background: {{item.isActive || item.isUnlocked ? item.colors.surface : (item.canUnlock ? item.colors.surface : 'rgba(0,0,0,0.3)')}}; color: {{item.isActive || item.isUnlocked ? item.colors.primary : (item.canUnlock ? item.colors.accent : '#FFFFFF')}};"
        >
          <text wx:if="{{item.isActive}}">✓ 使用中</text>
          <text wx:elif="{{item.isUnlocked}}">✓ 已解锁</text>
          <view wx:else style="display: flex; align-items: center; gap: 4rpx;">
            <svg width="12" height="12" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
              <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" stroke="{{item.canUnlock ? item.colors.accent : '#FFFFFF'}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <text>{{item.pointsCost}}积分</text>
          </view>
        </view>
        <view wx:if="{{!item.isUnlocked && !item.canUnlock}}" class="lock-overlay">
          <svg class="lock-icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </view>
      </view>
    </view>
  </view>

  <!-- 高级主题 -->
  <view class="theme-group">
    <view class="group-header">
      <text class="group-title" style="color: {{cssVars['--theme-text-primary']}};">高级主题</text>
      <view class="group-badge" style="background: {{cssVars['--theme-secondary']}}20; color: {{cssVars['--theme-secondary']}};">
        <svg class="badge-icon" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path d="M3 17 L12 2 L21 17 L12 22 Z" stroke="{{cssVars['--theme-secondary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M12 2v20" stroke="{{cssVars['--theme-secondary']}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <text>付费</text>
      </view>
    </view>
    <view class="theme-grid">
      <view
        wx:for="{{premiumThemes}}"
        wx:key="id"
        class="theme-card"
        data-theme-id="{{item.id}}"
        bindtap="onThemeCardTap"
        style="background: {{item.colors.background}}; opacity: {{item.isUnlocked || item.canUnlock ? 1 : 0.6}};"
      >
        <view class="color-preview">
          <view class="color-dot-small" style="background: {{item.colors.primary}};" />
          <view class="color-dot-small" style="background: {{item.colors.secondary}};" />
          <view class="color-dot-small" style="background: {{item.colors.accent}};" />
        </view>
        <view class="card-theme-name" style="color: {{item.colors.textPrimary}};">
          {{item.name}}
        </view>
        <view
          class="status-badge {{item.isActive ? 'active' : ''}} {{item.isUnlocked ? 'unlocked' : ''}}"
          style="background: {{item.isActive || item.isUnlocked ? item.colors.surface : 'rgba(0,0,0,0.3)'}}; color: {{item.isActive || item.isUnlocked ? item.colors.primary : '#FFFFFF'}};"
        >
          <text wx:if="{{item.isActive}}">✓ 使用中</text>
          <text wx:elif="{{item.isUnlocked}}">✓ 已解锁</text>
          <view wx:else style="display: flex; align-items: center; gap: 4rpx;">
            <svg width="12" height="12" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle;">
              <path d="M3 17 L12 2 L21 17 L12 22 Z" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M12 2v20" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <text>{{item.price}}币</text>
          </view>
        </view>
        <view wx:if="{{!item.isUnlocked && !item.canUnlock}}" class="lock-overlay">
          <svg class="lock-icon" width="24" height="24" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="11" width="18" height="11" rx="2" ry="2" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M7 11V7a5 5 0 0 1 10 0v4" stroke="#FFFFFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </view>
      </view>
    </view>
  </view>

  <!-- 返回顶部按钮 -->
  <view
    wx:if="{{showBackToTop}}"
    class="back-to-top"
    bindtap="scrollToTop"
    style="background: {{cssVars['--theme-primary']}};"
  >
    <text class="back-icon">↑</text>
  </view>
</scroll-view>

<!-- 预览弹窗 -->
<view
  wx:if="{{selectedPreview}}"
  class="preview-overlay"
  bindtap="closePreview"
>
  <view class="preview-mask" />
  <view
    class="preview-modal"
    catchtap="stopPropagation"
  >
    <!-- 关闭滑块 -->
    <view class="modal-handle" style="background: {{selectedPreview.colors.background}};">
      <view class="handle-bar" style="background: {{selectedPreview.colors.border}};" />
    </view>

    <!-- 可滚动的内容区域 -->
    <scroll-view
      class="modal-content"
      scroll-y
      style="background: {{selectedPreview.colors.background}};"
    >
      <!-- 主题名称 -->
      <view class="modal-title" style="color: {{selectedPreview.colors.textPrimary}};">
        {{selectedPreview.name}}
      </view>

      <!-- 主题类型标签 -->
      <view class="modal-type-badge">
        <view wx:if="{{selectedPreview.type === 'free'}}" class="type-tag" style="background: {{selectedPreview.colors.primary}}20; color: {{selectedPreview.colors.primary}};">
          <svg class="tag-icon" width="16" height="16" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect x="4" y="9" width="16" height="12" rx="1" stroke="{{selectedPreview.colors.primary}}" stroke-width="2"/>
            <line x1="12" y1="9" x2="12" y2="21" stroke="{{selectedPreview.colors.primary}}" stroke-width="1.5"/>
            <path d="M4 12h16" stroke="{{selectedPreview.colors.primary}}" stroke-width="1.5"/>
            <path d="M7 9c0-2 1-4 5-4s5 2 5 4" stroke="{{selectedPreview.colors.primary}}" stroke-width="1.5"/>
          </svg>
          <text>免费主题</text>
        </view>
        <view wx:elif="{{selectedPreview.type === 'signin'}}" class="type-tag" style="background: {{selectedPreview.colors.primary}}20; color: {{selectedPreview.colors.primary}};">
          <svg class="tag-icon" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" stroke="{{selectedPreview.colors.primary}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="16" y1="2" x2="16" y2="6" stroke="{{selectedPreview.colors.primary}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="8" y1="2" x2="8" y2="6" stroke="{{selectedPreview.colors.primary}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <line x1="3" y1="10" x2="21" y2="10" stroke="{{selectedPreview.colors.primary}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <text>签到{{selectedPreview.signinDays}}天解锁</text>
        </view>
        <view wx:elif="{{selectedPreview.type === 'points'}}" class="type-tag" style="background: {{selectedPreview.colors.accent}}20; color: {{selectedPreview.colors.accent}};">
          <svg class="tag-icon" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z" stroke="{{selectedPreview.colors.accent}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <text>{{selectedPreview.pointsCost}}积分</text>
        </view>
        <view wx:elif="{{selectedPreview.type === 'premium'}}" class="type-tag" style="background: {{selectedPreview.colors.secondary}}20; color: {{selectedPreview.colors.secondary}};">
          <svg class="tag-icon" width="14" height="14" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M3 17 L12 2 L21 17 L12 22 Z" stroke="{{selectedPreview.colors.secondary}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 2v20" stroke="{{selectedPreview.colors.secondary}}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <text>高级主题 {{selectedPreview.price}}心晴币</text>
        </view>
      </view>

      <!-- 颜色展示 -->
      <view class="modal-section">
        <view class="modal-section-title" style="color: {{selectedPreview.colors.textSecondary}};">主题配色</view>
        <view class="color-grid">
          <view class="color-item">
            <view class="color-square" style="background: {{selectedPreview.colors.primary}};" />
            <view class="color-label">主色</view>
          </view>
          <view class="color-item">
            <view class="color-square" style="background: {{selectedPreview.colors.secondary}};" />
            <view class="color-label">辅色</view>
          </view>
          <view class="color-item">
            <view class="color-square" style="background: {{selectedPreview.colors.accent}};" />
            <view class="color-label">强调</view>
          </view>
        </view>
      </view>

      <!-- 效果预览 -->
      <view class="modal-section">
        <view class="modal-section-title" style="color: {{selectedPreview.colors.textSecondary}};">效果预览</view>
        <view class="preview-example" style="background: {{selectedPreview.colors.surface}};">
          <view class="example-header">
            <view class="example-avatar" style="background: {{selectedPreview.colors.primary}};" />
            <view class="example-text">
              <view class="example-title" style="color: {{selectedPreview.colors.textPrimary}};">示例标题</view>
              <view class="example-subtitle" style="color: {{selectedPreview.colors.textSecondary}};">示例内容文字</view>
            </view>
          </view>
          <view class="example-button" style="background: {{selectedPreview.colors.primary}};">
            按钮示例
          </view>
        </view>
      </view>

      <!-- 底部留白，防止被按钮遮挡 -->
      <view style="height: 48rpx;"></view>
    </scroll-view>

    <!-- 固定在底部的操作按钮 -->
    <view class="modal-actions" style="background: {{selectedPreview.colors.background}};">
      <button
        wx:if="{{selectedPreview.type === 'signin' && !selectedPreview.isUnlocked && !selectedPreview.canUnlock}}"
        class="action-button secondary"
        bindtap="navigateToCheckin"
        style="background: {{selectedPreview.colors.secondary}};"
      >
        去签到 ({{continuousDays}}/{{selectedPreview.signinDays}}天)
      </button>
      <button
        class="action-button primary"
        bindtap="handleApplyTheme"
        style="background: {{selectedPreview.colors.primary}};"
      >
        {{previewButtonText}}
      </button>
    </view>
  </view>
</view>
